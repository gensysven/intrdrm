name: Daily Connection Generation

on:
  schedule:
    # Run daily at 2 AM UTC (adjust to your timezone)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggers
    inputs:
      count:
        description: 'Number of connections to generate'
        required: false
        default: '20'
      delay:
        description: 'Delay between generations (seconds)'
        required: false
        default: '10'

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Set up Codex authentication
        run: |
          mkdir -p ~/.codex
          echo '${{ secrets.CODEX_AUTH_JSON }}' > ~/.codex/auth.json
          chmod 600 ~/.codex/auth.json
        env:
          CODEX_AUTH_JSON: ${{ secrets.CODEX_AUTH_JSON }}

      - name: Verify Codex authentication
        run: codex --version || echo "Warning: Codex CLI not found in PATH"

      - name: Create environment file
        run: |
          cat > .env.local << EOF
          NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_KEY=${{ secrets.SUPABASE_SERVICE_KEY }}
          SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}
          EOF

      - name: Run health check (pre-generation)
        run: npm run health-check || echo "Pre-generation health check completed with warnings"

      - name: Generate connections
        run: |
          COUNT=${{ github.event.inputs.count || '20' }}
          DELAY=${{ github.event.inputs.delay || '10' }}
          ./scripts/generate-batch.sh $COUNT $DELAY
        env:
          NODE_OPTIONS: '--max-old-space-size=4096'

      - name: Run health check (post-generation)
        if: always()
        run: npm run health-check || echo "Post-generation health check completed with warnings"

      - name: Upload generation logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generation-logs-${{ github.run_number }}
          path: logs/*.log
          retention-days: 30

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Daily generation failed!"
          echo "Check the logs artifact for details."
          # Slack notification will be sent by health-check script
